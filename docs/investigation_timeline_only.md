# timeline_only原因調査レポート

**調査日**: 2026-01-05
**対象試合**: JP1-555841779

---

## 概要

ward座標抽出パイプラインにおいて、タイムラインにwardイベントがあるがYOLO検出とマッチングできなかった18件（timeline_only）の原因を調査した。

---

## 原因分類

| 原因 | 件数 | 割合 |
|------|------|------|
| チーム不一致（YOLO誤分類） | 9件 | 50% |
| その他（大きなフレーム差） | 6件 | 33% |
| tolerance境界ギリギリ | 3件 | 17% |

---

## 詳細分析

### 1. チーム不一致（9件）- 最大の問題

YOLOが検出したwardのチームが、タイムラインと逆になっているケース。

| ward_id | ward_type | timeline team | 検出team | frame |
|---------|-----------|---------------|----------|-------|
| 74 | BLUE_TRINKET | blue | red | 2100 |
| 77 | CONTROL_WARD | red | blue | 2111 |
| 78 | CONTROL_WARD | red | blue | 2151 |
| 87 | CONTROL_WARD | red | blue | 2336 |
| 90 | BLUE_TRINKET | blue | red | 2445 |
| 103 | SIGHT_WARD | red | blue | 2774 |
| 104 | SIGHT_WARD | red | blue | 2817 |
| 108 | SIGHT_WARD | blue | red | 2927 |
| 122 | SIGHT_WARD | blue | red | 3215 |

**考察**:
- YOLOモデルのクラス（stealth_ward vs stealth_ward_enemy等）の分類精度問題
- 特に中盤以降（frame 2000+）で発生頻度が高い
- CONTROL_WARDとSIGHT_WARDで多発

### 2. tolerance境界（3件）

現在の許容範囲（-30〜+90フレーム）をわずかに超えているケース。

| ward_id | ward_type | team | frame | 最近接検出との差 |
|---------|-----------|------|-------|-----------------|
| 53 | CONTROL_WARD | blue | 1552 | -31 |
| 73 | YELLOW_TRINKET | red | 2089 | -33 |
| 124 | BLUE_TRINKET | red | 3225 | -40 |

**対策案**: toleranceを30→50に拡大

### 3. その他（6件）

フレーム差が大きく、根本的に検出できていない可能性。

| ward_id | ward_type | team | frame | 最近接との差 |
|---------|-----------|------|-------|-------------|
| 63 | YELLOW_TRINKET | red | 1839 | -62 |
| 66 | SIGHT_WARD | red | 1853 | -76 |
| 76 | SIGHT_WARD | red | 2109 | -53 |
| 86 | CONTROL_WARD | blue | 2314 | -228 |
| 89 | SIGHT_WARD | red | 2379 | -121 |
| 125 | SIGHT_WARD | red | 3236 | -51 |

**考察**:
- 検出漏れ（wardが画面上に表示されていない、または非常に短時間のみ表示）
- タイムスタンプ↔フレーム変換の誤差

---

## 改善案

### 短期（パラメータ調整）

1. **tolerance拡大**: 30 → 50フレーム
   - 効果: 3件の改善見込み
   - リスク: 誤マッチング増加の可能性

### 中期（アルゴリズム改善）

2. **チーム判定の緩和オプション**
   - ward_typeが一致していれば、チームが異なっても候補として検討
   - タイムラインのチーム情報を優先して採用

### 長期（モデル改善）

3. **YOLOモデルの再学習**
   - チーム分類精度の向上（enemy vs non-enemy）
   - 特にCONTROL_WARDとSIGHT_WARDでの精度向上

---

## 調査用フレーム一覧

以下のフレームを目視確認することで、原因をさらに特定可能。

```
C:\dataset_20260101\JP1-555841779\0\
```

| 確認対象 | フレーム番号 | 確認ポイント |
|---------|-------------|-------------|
| チーム誤分類 | 2100, 2111, 2151 | wardの色・形状確認 |
| 検出漏れ | 2314, 2379 | wardが画面に表示されているか |
| tolerance境界 | 1552, 2089 | wardの出現タイミング |

---

## 結論

timeline_only 18件の主要因は**YOLOモデルのチーム分類誤り（50%）**である。
マッチング率を90%以上に向上させるには、以下が必要：

1. tolerance拡大（3件改善）
2. チーム判定ロジックの緩和（最大9件改善）
3. 検出漏れの原因調査（6件）
