# LoL視界スコア指標による勝率予測精度向上の試み

## 1. 研究目的

### 背景
- League of Legendsにおいて「視界（Vision）」は勝敗を左右する重要な戦術要素
- 先行研究（WARDS論文）では視界スコアが勝率予測に寄与することを示唆
- Riot公式の`visionScore`は試合終了後にのみ取得可能で、リアルタイム予測には使用不可

### 目的
**リプレイ映像からward座標を抽出し、独自の視界スコア指標を作成することで、勝率予測精度の向上を目指す**

### 仮説
「wardの配置座標（どこに置いたか）」を特徴量として組み込むことで、単純なward設置数よりも高い予測精度が得られる

---

## 2. 手法

### 2.1 データ収集パイプライン

```
Riot API → matchId取得 → .roflダウンロード → リプレイ再生 → ミニマップキャプチャ
```

- **対象**: JPサーバー、Diamond帯、パッチ25.S1.2
- **収集試合数**: 123試合

### 2.2 Ward検出

| 項目 | 内容 |
|------|------|
| モデル | YOLOv8n |
| 学習データ | 手動アノテーション 1,500枚 |
| クラス | stealth_ward, stealth_ward_enemy, control_ward, control_ward_enemy |
| 検出後処理 | 時系列クラスタリング + Riot APIタイムラインとのマッチング |

### 2.3 特徴量設計

| 特徴量セット | 内容 | 次元数 |
|--------------|------|--------|
| baseline | gold, kills, dragons, towers, wards_placed 等 | 20 |
| +Riot visionScore | visionScorePerMinuteからの推定値 | +3 |
| +wardグリッド | 32x32グリッドへのward配置累積統計量 | +6 |
| **+戦術スコア** | **ヒートマップ重要度ベースのward評価** | **+6** |

### 2.4 戦術スコアの設計（新規提案）

#### ヒートマップ重要度マップ
- ward座標グリッド(32x32)と勝敗のロジスティック回帰から抽出
- 各セルに「勝敗への寄与度」を割り当て
- 正の値=Blue有利、負の値=Red有利

#### スコアリングルール

| スコア | 条件（重要度の絶対値） |
|--------|------------------------|
| 2点 | >= 0.03（強い相関） |
| 1点 | 0.01 ~ 0.03（弱い相関） |
| 0点 | < 0.01（相関なし） |

- **設置スコア**: 自チームに有利な位置にwardを置くと獲得
- **破壊スコア**: 敵チームに有利な位置の敵wardを破壊すると獲得

### 2.5 評価設定

- **有効試合数**: 92試合（20分以上継続）
- **評価時点**: 10分、20分
- **評価手法**: Leave-One-Out Cross Validation
- **モデル**: ロジスティック回帰

---

## 3. 実験結果

### 3.1 モデル性能比較

#### 10分時点

| モデル | Accuracy | AUC | 精度向上 |
|--------|----------|-----|----------|
| baseline | 59.8% | 0.648 | - |
| +Riot visionScore | 68.5% | 0.710 | +8.7% |
| +wardグリッド | 59.8% | 0.648 | +0.0% |
| **+戦術スコア** | **77.2%** | **0.826** | **+17.4%** |

#### 20分時点

| モデル | Accuracy | AUC | 精度向上 |
|--------|----------|-----|----------|
| baseline | 80.4% | 0.901 | - |
| +Riot visionScore | 84.8% | 0.907 | +4.4% |
| +wardグリッド | 80.4% | 0.884 | +0.0% |
| **+戦術スコア** | **88.0%** | **0.945** | **+7.6%** |

### 3.2 特徴量重要度（10分時点、戦術スコアモデル）

| 順位 | 特徴量 | 重要度 |
|------|--------|--------|
| 1 | red_placement_score | 0.676 |
| 2 | blue_placement_score | 0.366 |
| 3 | red_dragons | 0.276 |
| 4 | red_total_cs | 0.261 |
| 5 | blue_deny_score | 0.259 |

### 3.3 主要な発見

1. **戦術スコアは最も高い予測精度を達成**（10分時点で+17.4%）
2. **Riot visionScoreを上回る性能**（+8.7% vs +17.4%）
3. **単純なwardグリッド特徴量は効果なし**（位置の戦術的価値を考慮していないため）
4. **序盤（10分時点）ほど戦術スコアの効果が顕著**

---

## 4. 考察

### 4.1 なぜ戦術スコアは効果的だったか

| 要因 | 説明 |
|------|------|
| 位置の価値を定量化 | 全てのwardを同等に扱わず、戦術的に重要な位置を高評価 |
| 勝敗との相関を学習 | ヒートマップから「勝利に寄与するward配置」を学習済み |
| 低次元で効率的 | 6特徴量のみで高い予測力を実現 |

### 4.2 なぜwardグリッド特徴量は効かなかったか

| 要因 | 説明 |
|------|------|
| 情報の冗長性 | baselineに`wards_placed`（設置数）が既に含まれる |
| 文脈の欠落 | 「どこに」だけでは不十分。戦術的価値を考慮していない |
| 次元の呪い | 高次元特徴量は92試合では学習困難 |

### 4.3 Riot visionScoreとの比較

| 観点 | Riot visionScore | 戦術スコア |
|------|------------------|------------|
| 計算方法 | Riot社の非公開アルゴリズム | ヒートマップ重要度による評価 |
| 予測精度向上 | +8.7%（10分） | **+17.4%**（10分） |
| 利点 | 公式指標 | **位置の戦術的価値を反映** |

---

## 5. 成果物

| 成果物 | 説明 |
|--------|------|
| データパイプライン | リプレイ収集〜ward座標抽出の自動化 |
| YOLOv8モデル | ward検出モデル（models/best.pt） |
| 戦術スコア計算 | autoLeague/scoring/tactical_scorer.py |
| ヒートマップ可視化 | heatmaps/importance_*.png |
| データセット | 92試合分の特徴量（data/prediction_dataset.npz） |

---

## 6. 結論

### 仮説の検証結果

> 「ward座標を特徴量として組み込むことで予測精度が向上する」

**採択：戦術スコア化により+17.4%の精度向上を達成**

### 得られた知見

1. ward座標の「生データ」は勝敗予測に直接寄与しない
2. **wardの戦術的価値（どこに置くか）を定量化することで、Riot visionScoreを上回る精度向上を実現**
3. ヒートマップを用いた「勝敗に寄与するward配置」の学習が有効

---

## 7. 今後の展望

| アプローチ | 内容 |
|------------|------|
| 時間帯別最適化 | 5分刻みのヒートマップを活用した精緻化 |
| 破壊スコアの強化 | ward破壊の戦術的価値をより精密に評価 |
| チャンピオン座標統合 | 視界が「何を捉えたか」を評価可能に |
| より多くのデータ | 123試合→数百試合での検証 |

---

## 参考資料

- 戦術スコア評価結果: `results/tactical_score_evaluation.json`
- 戦術スコアサマリー: `results/tactical_score_summary.md`
- モデル比較グラフ: `results/model_comparison.png`
- 特徴量重要度: `results/feature_importance_*.png`
- ヒートマップ: `heatmaps/importance_grid.png`
